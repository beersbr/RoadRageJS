<!doctype html>
<html>
<head>
<title>road rage</title>
<link rel="stylesheet" type="text/css" href="./styles/main.css">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script type="text/javascript" src="./javascripts/utility.js"></script>
<script type="text/javascript" src="./javascripts/input.js"></script>
<script type="text/javascript" src="./javascripts/asset_loader.js"></script>
<script type="text/javascript" src="./javascripts/sprite_handler.js"></script>

<script type="text/javascript">

// init some globals -- on purpose
(function(){
	MENU = 0;
	PLAYING = 1;
	PAUSED = 2;
	LOADING = 10;
})();

Game = {};

Game.width = 800;
Game.height = 600;

// The initial loading function -- somewhat of a hack
Game.loading = function()
{
	// update
	if(Game.assets.complete)
	{
		Game.gameState = PLAYING;
	}

	var completed = Game.assets.load();
	var width = 600 * completed;

	// draw
	Game.context.fillRect(0, 0, 800, 600);
	Game.context.save();
		Game.context.strokeStyle = "rgb(200, 200, 200)";
		Game.context.strokeRect(100, 290, 600, 20);
		Game.context.stroke();
		Game.context.fillStyle = "rgb(100, 128, 200)";
		Game.context.fillRect(100, 290, width, 20);
	Game.context.restore();

	return true;	
}

Game.id = 0;
Game.getId = function()
{
	return (Game.id++);
}

function Entity(args)
{
	args = (args == undefined) ? {} : args;

	this._name = "Entity";
	this._id = getId();

	this.x = args.x || 0;
	this.y = args.y || 0;
	this.w = args.w || 0;
	this.h = args.h || 0;
	
	this.vx = args.vx || 0.0;
	this.vy = args.vy || 0.0;

	this.Update = function(args)
	{
		return true;
	}

	this.Draw = function(renderContext)
	{
		return true;
	}
}

function Level(args)
{
	this._name = "Level";
	this._id = Game.getId();

	this.w = args.w || 0;
	this.h = args.h || 0;

	this.image = document.createElement("canvas");

	this.image.width  = this.w;
	this.image.height = this.h;

	this.animated_tiles = [];

	this.update = function()
	{

	}

	this.draw = function(render_context, x, y, w, h)
	{

	}

	this.load = function(level_name)
	{
		// get the level as an object
	}
}

function Tile(args)
{
	this._name = "Tile";
	this._id = Game.getId();

	this.image = args.image
	this.x = args.x || 0;
	this.y = args.y || 0;
	this.w = args.w || this.image.w;
	this.h = args.h || this.image.h;

	this.sprite = new SpriteHandler({image: this.image,
									 tile_width: this.w,
									 tile_height: this.h
									});

	// this will determine whether or not we need to continue to keep track of the tile.
	this.animated = (this.sprite.frame_count > 0) ? true : false;

	this.Draw = function(render_context)
	{
		this.sprite.draw(render_context, this.x, this.y);
		return this.animated;
	}
}	
	
function Player(args) //accepts user input and moves car, calculating speed, sending position to server
{
	args = (args == undefined) ? {} : args;

	Utility.InheretFrom(this, Entity, args);

	this._name = "Player";
	this._id = Game.getId();

	this.w = 50;
	this.h = 75;

	this.x = args.x || 0;
	this.y = args.y || 0;

	this.acceleration = 4;
	this.turn_speed = 2.5;

	this.angle = args.angle || 0;
	this.image = args.image || 0;

	this.sprite =  new SpriteHandler({image: this.image, tile_width: this.w, tile_height: this.h});

	
	this.update = function(time)
	{

		var keyboard = Game.keyboard;

		if(keyboard.keyIsDown("up_arrow"))
		{
			this.x -= this.player_speed * time;
		}
		if(keyboard.keyIsDown("down_arrow"))
		{
			this.x += this.player_speed * time;
		}

		return true;
	}
    ;

	this.draw = function(context)
	{
		this.sprite.draw(context, this.x, this.y);
		return true;
	}
}

function loop()
{
	Game.time = +(new Date());
	Game.elapsed_time = Game.time - Game.old_time
	Game.old_time = Game.time
	Game.elapsed_milliseconds = Game.elapsed_time / 1000; 

	switch(Game.state)
	{
		case LOADING:
			Game.loading();
			break;

		case MENU:
			break;

		case PLAYING:
			break;

		case PAUSED:
			break;
	}

	requestAnimFrame(loop);
}

// set up the game objects that are needed from the start
function setup()
{
	Game.keyboard = new KeyboardHandler();
	Game.context = document.getElementById("simulation-canvas").getContext("2d");
	Game.assets = new AssetHandler();

	Game.start_time = +(new Date());
	Game.old_time = +(new Date());
	Game.elapsed_time = Game.old_time = Game.running_time;

	var images_object = null;

	// mark the assets in the image_map.json for loading.
	$.ajax({
		async: false,
		url: "json/image_map.json",
		success: function(ret){
			images_object = ret;
		}
	});

	var images_object_keys = Object.keys(images_object["images"]);

	for(var i = 0; i < images_object_keys.length; i++)
	{
		var key = images_object_keys[i];
		var	path = images_object["images"][key];

		Game.assets.tagAsset(key, path);
	}

	Game.state = LOADING;

	return true;
}

window.onload = function()
{
	setup();
	loop();
}

</script>

</head>
<body>
	<canvas id="simulation-canvas" width="800px" height="600px">Update your browser.</canvas>
</body>
</html>